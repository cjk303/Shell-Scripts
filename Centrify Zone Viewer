# Import the Centrify PowerShell module
Import-Module Centrify.DirectControl.PowerShell

# Get all managed computers from Centrify
$computers = Get-CdmManagedComputer

# Get all zones for later matching
$allZones = Get-CdmZone

# Prepare results
$results = foreach ($computer in $computers) {
    # Debug: See if ZoneGuid exists and is not empty
    $zoneGuid = $computer.ZoneGuid
    $zone = $null

    if ($zoneGuid) {
        $zone = $allZones | Where-Object { $_.Guid -eq $zoneGuid }
    }

    # Extract domain name from Distinguished Name (DN)
    $dn = $computer.DistinguishedName
    $domainName = "Unknown"

    if ($dn -and $dn -match "DC=") {
        try {
            $domainParts = ($dn -split ",") | Where-Object { $_ -like "DC=*" }
            $domainName = ($domainParts -replace "DC=") -join "."
        } catch {
            $domainName = "ParseError"
        }
    }

    [PSCustomObject]@{
        ComputerName = $computer.Name
        Domain       = $domainName
        Zone         = if ($zone) { $zone.Name } else { "Unknown or No Match" }
        ZoneGuid     = $zoneGuid
        DistinguishedName = $dn
    }
}

# Output as table
$results | Format-Table -AutoSize

# Optionally export to CSV
# $results | Export-Csv -Path "CentrifyComputers.csv" -NoTypeInformation
